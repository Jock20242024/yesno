# 采集源和全局指标问题修复说明

## 问题1：Polymarket采集源一直在"抓取中"

### 问题原因
手动运行采集任务时，如果任务执行时间过长或失败，状态没有及时更新，导致前端一直显示"抓取中"。

### 修复方案
1. **在任务开始前更新状态**：执行采集前，先将任务状态更新为"正在抓取中..."
2. **添加错误处理**：如果采集失败，立即更新状态为"异常"
3. **超时保护**：API 已设置 `maxDuration = 300`（5分钟超时）

### 修复代码位置
- `app/api/admin/scrapers/[sourceName]/run/route.ts`

### 使用方法
1. 点击"手动运行"按钮
2. 如果任务卡住超过5分钟，会自动超时并更新状态
3. 如果任务失败，状态会立即更新为"异常"

---

## 问题2：前端预测市场数据指标为空

### 问题原因
前端从 `/api/stats` 获取数据，该API从 `global_stats` 表读取。如果表为空，前端就显示为空。

### 解决方案

#### 方案A：在后台管理界面创建指标（推荐）
1. 进入后台管理 → 数据采集源监控 → 全局指标管理
2. 点击"+ 添加新指标"
3. 创建以下4个指标：
   - **指标名称**: `进行中事件`
   - **数值**: `0`（脚本会自动更新）
   - **单位**: 留空
   - **图标**: `Activity` 或 `TrendingUp`
   - **排序**: `1`
   - **状态**: `启用`

   - **指标名称**: `24H 交易量`
   - **数值**: `0`
   - **单位**: `$`
   - **图标**: `DollarSign`
   - **排序**: `2`
   - **状态**: `启用`

   - **指标名称**: `总锁仓量 (TVL)`
   - **数值**: `0`
   - **单位**: `$`
   - **图标**: `BarChart3`
   - **排序**: `3`
   - **状态**: `启用`

   - **指标名称**: `24H 活跃交易者`
   - **数值**: `0`
   - **单位**: 留空
   - **图标**: `Users`
   - **排序**: `4`
   - **状态**: `启用`

#### 方案B：运行初始化脚本
运行以下命令创建默认指标：
```bash
npx tsx scripts/scrapers/calculate-global-stats.ts
```

注意：脚本只会更新已存在的指标，不会自动创建。所以**必须先通过方案A创建指标**。

---

## 问题3：实时数据面板的采集源和逻辑

### 数据流程

```
前端组件 (MarketOverview.tsx)
    ↓ 每60秒请求
/api/stats (GET)
    ↓ 查询数据库
global_stats 表
    ↓ 数据来源
scripts/scrapers/calculate-global-stats.ts (脚本B)
```

### 脚本B：全网数据计算 (`scripts/scrapers/calculate-global-stats.ts`)

**职责**：
1. 从 Polymarket Gamma API 获取全量活跃市场数据（最多1000条）
2. 计算全网统计数据：
   - **进行中事件**：统计活跃事件总数（去重后）
   - **24H 交易量**：计算所有市场的总交易量
   - **总锁仓量 (TVL)**：计算所有市场的总流动性
   - **24H 活跃交易者**：基于交易量估算（每 $10,000 交易量对应 1 个活跃用户）
3. 更新 `global_stats` 表：直接写入中文标签对应的指标值
4. 更新监控状态：更新 `scraper_tasks` 表中 `name === 'GlobalStats_Calc'` 的记录

**运行方式**：
- **手动运行**：`npx tsx scripts/scrapers/calculate-global-stats.ts`
- **定时任务**：可通过 cron 定时触发（建议每10分钟运行一次）

**防破坏逻辑**：
- 如果指标在数据库中不存在或被禁用，脚本**禁止创建或更新**它
- 必须先通过后台管理界面创建指标，脚本才能更新数值

### 数据更新流程

1. **脚本B运行** → 从 Polymarket API 获取数据
2. **计算统计数据** → 基于获取的市场数据计算各项指标
3. **更新数据库** → 更新 `global_stats` 表中对应 label 的 `value` 字段
4. **前端获取** → `MarketOverview` 组件每60秒从 `/api/stats` 获取最新数据
5. **显示更新** → 前端实时显示更新后的指标值

### 相关文件
- **前端组件**: `components/MarketOverview.tsx`
- **API接口**: `app/api/stats/route.ts`
- **计算脚本**: `scripts/scrapers/calculate-global-stats.ts`
- **后台管理API**: `app/api/admin/stats/route.ts`

---

## 快速修复步骤

### 1. 修复Polymarket采集源"抓取中"问题
✅ 已修复：代码已更新，任务开始前会更新状态，失败时会立即更新为异常状态。

### 2. 创建全局指标
1. 进入后台管理 → 数据采集源监控 → 全局指标管理
2. 点击"+ 添加新指标"
3. 创建4个指标（见上方"方案A"）
4. 确保所有指标状态为"启用"

### 3. 运行计算脚本
```bash
npx tsx scripts/scrapers/calculate-global-stats.ts
```

### 4. 验证
1. 刷新前端页面，检查"预测市场实时数据"面板是否显示数据
2. 检查后台管理 → 全局指标管理，确认指标数值已更新

---

## 注意事项

1. **指标名称必须精确匹配**：脚本使用精确匹配查找指标，名称必须完全一致（包括空格和大小写）
2. **指标必须先创建**：脚本不会自动创建指标，必须先通过后台管理界面创建
3. **脚本只更新数值**：脚本只更新 `value` 字段，不会修改其他字段（如 `label`、`unit`、`icon` 等）
4. **定时任务建议**：建议设置 cron 任务每10分钟运行一次脚本B，确保数据实时更新

