# 功能测试与安全性测试执行计划

**测试日期**: 2025-01-30  
**测试范围**: 核心功能测试、安全性测试

---

## 1. 功能测试清单

### 1.1 管理员功能测试

#### 管理员认证与权限
- [ ] **管理员登录**
  - 测试步骤：访问 `/admin/login`，使用管理员账号登录
  - 预期结果：成功登录，跳转到 `/admin/dashboard`
  - 关键验证：Token 通过 HttpOnly Cookie 发送（而非硬编码）

- [ ] **权限验证**
  - 测试步骤：未登录用户访问 `/api/admin/markets/review`
  - 预期结果：返回 401 Unauthorized
  - 关键验证：`verifyAdminToken` 正确验证权限

#### 市场管理
- [ ] **创建市场**
  - 测试步骤：管理员登录后访问 `/admin/markets/create`，填写表单并提交
  - 预期结果：市场创建成功，显示成功提示
  - 关键验证：使用 `credentials: 'include'` 发送请求（而非硬编码 Token）

- [ ] **审核市场**
  - 测试步骤：访问 `/admin/markets/review`，选择一个市场进行审核
  - 预期结果：审核成功，市场状态更新
  - 关键验证：权限检查正常工作

- [ ] **结算监控**
  - 测试步骤：访问 `/admin/settlement`
  - 预期结果：显示待结算和已结算的市场列表
  - 关键验证：API 返回正确的数据格式

#### 提现审批
- [ ] **提现审批**
  - 测试步骤：访问 `/admin/withdrawals`，审批一个提现请求
  - 预期结果：提现状态更新，用户余额正确
  - 关键验证：使用 `credentials: 'include'` 发送请求（而非硬编码 Token）

---

### 1.2 用户功能测试

#### 用户认证
- [ ] **用户注册**
  - 测试步骤：访问 `/register`，填写表单并提交
  - 预期结果：注册成功，自动登录

- [ ] **用户登录**
  - 测试步骤：访问 `/login`，使用已注册账号登录
  - 预期结果：登录成功，跳转到首页或指定页面

#### 市场浏览
- [ ] **查看市场列表**
  - 测试步骤：访问首页或分类页面（如 `/category/crypto`）
  - 预期结果：显示市场列表，分类和时间筛选器正常工作
  - 关键验证：翻译正确显示（中文/英文切换）

- [ ] **查看市场详情**
  - 测试步骤：点击一个市场，查看详情页
  - 预期结果：显示市场详细信息、价格、持仓等

#### 交易功能
- [ ] **创建订单**
  - 测试步骤：在市场详情页，选择 YES/NO，输入金额，提交订单
  - 预期结果：订单创建成功，余额正确扣除

- [ ] **查看订单**
  - 测试步骤：访问用户订单页面
  - 预期结果：显示用户的所有订单
  - 关键验证：只能看到自己的订单（数据隔离）

- [ ] **取消订单**
  - 测试步骤：取消一个待处理的订单
  - 预期结果：订单取消成功，余额退回

#### 资金管理
- [ ] **充值**
  - 测试步骤：访问钱包页面，进行充值
  - 预期结果：充值记录创建成功

- [ ] **提现**
  - 测试步骤：访问钱包页面，申请提现
  - 预期结果：提现请求创建成功

- [ ] **查看交易记录**
  - 测试步骤：访问交易记录页面
  - 预期结果：显示充值、提现、订单等记录
  - 关键验证：只能看到自己的记录（数据隔离）

---

## 2. 安全性测试清单

### 2.1 认证与授权

#### 权限验证
- [ ] **非管理员访问管理 API**
  - 测试步骤：普通用户登录后，尝试访问 `/api/admin/markets/review`
  - 预期结果：返回 403 Forbidden
  - 关键验证：`verifyAdminToken` 正确拒绝非管理员用户

- [ ] **未登录访问受保护 API**
  - 测试步骤：未登录状态下，访问 `/api/orders/user`
  - 预期结果：返回 401 Unauthorized

#### Token 安全性
- [ ] **硬编码 Token 测试**
  - 测试步骤：检查浏览器 DevTools Network 标签，查看 API 请求
  - 预期结果：**不应**看到 `Authorization: Bearer ADMIN_SECRET_TOKEN` 等硬编码 Token
  - 关键验证：所有请求使用 `credentials: 'include'` 自动发送 Cookie

- [ ] **Token 传输安全**
  - 测试步骤：检查 API 请求头
  - 预期结果：Token 通过 HttpOnly Cookie 传输（不在请求头中暴露）

---

### 2.2 数据隔离

#### 用户数据隔离
- [ ] **订单数据隔离**
  - 测试步骤：
    1. 使用用户A登录，创建订单
    2. 使用用户B登录，访问订单列表
  - 预期结果：用户B只能看到自己的订单，看不到用户A的订单
  - 关键验证：API 使用 `WHERE userId = current_user_id` 过滤

- [ ] **交易记录隔离**
  - 测试步骤：
    1. 使用用户A登录，查看交易记录
    2. 使用用户B登录，查看交易记录
  - 预期结果：每个用户只能看到自己的交易记录
  - 关键验证：API 使用 `WHERE userId = current_user_id` 过滤

- [ ] **余额隔离**
  - 测试步骤：
    1. 使用用户A登录，查看余额
    2. 使用用户B登录，查看余额
  - 预期结果：每个用户看到自己的余额
  - 关键验证：API 从正确的用户记录中获取余额

#### 数据泄露测试
- [ ] **直接访问其他用户数据**
  - 测试步骤：用户A登录后，尝试访问 `/api/users/{userB_id}`
  - 预期结果：如果权限检查正确，应该返回 403 或只返回公开信息
  - 关键验证：API 验证用户ID匹配或返回公开数据

---

### 2.3 输入验证

- [ ] **SQL 注入测试**
  - 测试步骤：在输入框中输入 SQL 注入代码（如 `' OR '1'='1`）
  - 预期结果：请求被拒绝或数据被正确转义
  - 关键验证：使用 Prisma 的参数化查询（自动防止 SQL 注入）

- [ ] **XSS 测试**
  - 测试步骤：在输入框中输入 XSS 代码（如 `<script>alert('XSS')</script>`）
  - 预期结果：代码被转义，不会执行
  - 关键验证：React 自动转义用户输入

---

## 3. 性能测试（可选）

- [ ] **页面加载速度**
  - 测试步骤：使用浏览器 DevTools 检查页面加载时间
  - 预期结果：首屏加载时间 < 3秒

- [ ] **API 响应时间**
  - 测试步骤：使用浏览器 DevTools Network 标签检查 API 响应时间
  - 预期结果：API 响应时间 < 1秒

---

## 4. 测试执行记录

### 测试环境
- **测试日期**: _______________
- **测试人员**: _______________
- **浏览器**: _______________
- **测试环境**: [ ] 开发环境 [ ] 生产环境

### 测试结果
- **通过**: ___ / ___
- **失败**: ___ / ___
- **跳过**: ___ / ___

### 发现的问题
1. 
2. 
3. 

---

## 5. 自动化测试建议

### 单元测试
- API 路由测试（使用 Jest + Supertest）
- 工具函数测试
- 数据验证逻辑测试

### 集成测试
- 认证流程测试
- 订单创建流程测试
- 数据隔离测试

### E2E 测试（可选）
- 使用 Playwright 或 Cypress 进行端到端测试
- 覆盖关键用户流程

---

**测试执行完成后，请填写测试结果并记录发现的问题。**

