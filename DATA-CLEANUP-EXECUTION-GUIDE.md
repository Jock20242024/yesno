# 数据清洗执行指南

**阶段**: 阶段 2 - 数据清洗  
**执行时间**: 2025-01-30

---

## ⚠️ 重要警告

**在执行任何数据清洗操作之前，必须：**
1. ✅ **备份数据库**
2. ✅ 在**测试环境**先执行
3. ✅ 确认清洗结果后再在生产环境执行

---

## 📋 执行步骤

### 步骤 1: 数据备份（必须）

```bash
# 备份数据库（PostgreSQL）
pg_dump -h localhost -U username -d yesno_db > backup_$(date +%Y%m%d_%H%M%S).sql

# 或者使用环境变量
pg_dump $DATABASE_URL > backup_$(date +%Y%m%d_%H%M%S).sql
```

**验证备份**:
```bash
# 检查备份文件大小（应该 > 0）
ls -lh backup_*.sql
```

---

### 步骤 2: 数据分析（识别脏数据）

**目的**: 先分析需要清洗的数据，不做任何删除操作

```bash
# 运行数据分析脚本
npx tsx scripts/analyze-dirty-data.ts
```

**预期输出**:
- 测试用户数量
- 测试市场数量
- 无效订单数量
- 孤立订单数量
- 过期会话数量
- 重复市场数量

**检查点**:
- [ ] 确认数据分析脚本运行成功
- [ ] 记录各类脏数据的数量
- [ ] 评估清洗影响范围

---

### 步骤 3: 数据清洗预览（DRY RUN）

**目的**: 预览将要删除的数据，不实际删除

```bash
# DRY RUN 模式（默认，不会实际删除）
npx tsx scripts/cleanup-dirty-data.ts

# 或者明确指定
DRY_RUN=true npx tsx scripts/cleanup-dirty-data.ts
```

**检查点**:
- [ ] 确认预览的数据是预期的
- [ ] 确认没有误删重要数据
- [ ] 记录将要删除的数据量

---

### 步骤 4: 执行数据清洗（测试环境）

**⚠️ 警告**: 这一步会实际删除数据！

```bash
# 实际删除模式（仅在测试环境）
DRY_RUN=false npx tsx scripts/cleanup-dirty-data.ts
```

**检查点**:
- [ ] 确认在测试环境执行
- [ ] 确认数据库已备份
- [ ] 监控脚本执行过程
- [ ] 检查错误日志

---

### 步骤 5: 验证清洗结果

**验证清洗后的数据**:

```bash
# 再次运行数据分析脚本，确认数据已清理
npx tsx scripts/analyze-dirty-data.ts
```

**手动验证（SQL）**:

```sql
-- 检查测试用户是否已删除
SELECT COUNT(*) FROM users WHERE email LIKE '%test%';

-- 检查测试市场是否已删除
SELECT COUNT(*) FROM markets WHERE title LIKE '%test%';

-- 检查无效订单是否已删除
SELECT COUNT(*) FROM orders WHERE amount <= 0;

-- 检查过期会话是否已删除
SELECT COUNT(*) FROM auth_sessions WHERE expires_at < NOW();
```

**检查点**:
- [ ] 确认测试用户已删除（或符合预期）
- [ ] 确认测试市场已删除（或符合预期）
- [ ] 确认无效订单已删除
- [ ] 确认过期会话已删除
- [ ] 验证应用程序功能正常

---

### 步骤 6: 在生产环境执行（如果测试环境验证通过）

**⚠️ 警告**: 这是最后一步，仅在测试环境验证通过后执行！

1. **选择执行时间**: 选择低峰期执行
2. **通知团队**: 通知相关团队即将执行数据清洗
3. **再次备份**: 执行前再次备份生产数据库
4. **执行清洗**:
   ```bash
   DRY_RUN=false npx tsx scripts/cleanup-dirty-data.ts
   ```
5. **验证结果**: 执行后立即验证清洗结果
6. **监控应用**: 监控应用程序是否正常运行

---

## 📊 清洗范围

### 将被清洗的数据

1. **测试用户**
   - 邮箱包含 `test`、`demo`、`example` 的用户
   - 排除系统账户和管理员账户

2. **测试市场**
   - 标题包含 `测试`、`test`、`demo` 的市场
   - **仅删除从未有交易的市场**（totalVolume = 0）

3. **无效订单**
   - 金额 <= 0 的订单

4. **过期会话**
   - expiresAt < 当前时间的会话

### 不会被清洗的数据

- ✅ 系统账户（email 以 `system.` 开头）
- ✅ 管理员账户（`yesno@yesno.com`）
- ✅ 有交易量的测试市场（保留，因为有真实数据）

---

## 🔄 回滚方案

如果清洗出现问题，可以：

1. **从备份恢复**:
   ```bash
   psql $DATABASE_URL < backup_YYYYMMDD_HHMMSS.sql
   ```

2. **检查备份文件**: 确认备份文件完整

---

## 📝 执行记录

### 测试环境执行

**执行日期**: _______________  
**执行人员**: _______________  

**清洗前统计**:
- 测试用户: ____ 个
- 测试市场: ____ 个
- 无效订单: ____ 个
- 过期会话: ____ 个

**清洗后统计**:
- 测试用户: ____ 个
- 测试市场: ____ 个
- 无效订单: ____ 个
- 过期会话: ____ 个

**删除统计**:
- 删除用户: ____ 个
- 删除市场: ____ 个
- 删除订单: ____ 个
- 删除会话: ____ 个

**错误记录**:
- [ ] 无错误
- [ ] 有错误（记录错误信息）

---

### 生产环境执行（如果执行）

**执行日期**: _______________  
**执行时间**: _______________  
**执行人员**: _______________  

**清洗前统计**: (同上)  
**清洗后统计**: (同上)  
**删除统计**: (同上)  
**错误记录**: (同上)

---

## ⚠️ 注意事项

1. **备份优先**: 永远在清洗前备份数据库
2. **测试环境先行**: 所有操作先在测试环境验证
3. **DRY RUN**: 始终先使用 DRY RUN 模式预览
4. **分批执行**: 如果数据量很大，考虑分批执行
5. **监控应用**: 执行后监控应用程序是否正常运行
6. **记录日志**: 记录所有操作和结果

---

## ✅ 执行检查清单

- [ ] 数据库已备份
- [ ] 在测试环境执行
- [ ] 运行数据分析脚本
- [ ] 运行 DRY RUN 模式预览
- [ ] 确认预览数据正确
- [ ] 执行实际清洗（测试环境）
- [ ] 验证清洗结果
- [ ] 验证应用程序功能
- [ ] 记录执行结果
- [ ] （可选）在生产环境执行

---

**准备就绪后，请按照上述步骤执行数据清洗。**

