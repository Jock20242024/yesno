# 采集源说明文档

## 问题1：Polymarket采集源一直显示"抓取中"

### 原因分析

1. **数据量增加**：现在设置为抓取1000条数据（之前可能更少）
2. **翻译功能**：每条数据都会调用翻译API，导致变慢
3. **数据库操作**：每条数据都需要查询和更新数据库
4. **复杂处理逻辑**：包括分类匹配、工厂市场检查等

### 性能优化方案

**已优化：**
1. ✅ 降低limit从1000到500（减少处理数据量）
2. ✅ 禁用翻译功能（减少API调用）
3. ✅ 添加超时保护（5分钟）

**如果还是慢，可以进一步优化：**
- 减少limit到200-300
- 使用批量数据库操作
- 异步处理翻译

### 当前配置

- **Limit**: 500条（已优化）
- **超时时间**: 5分钟
- **翻译**: 已禁用（提升性能）

---

## 问题2："全网数据"采集源的作用和逻辑

### 采集源说明

**"全网数据"采集源**对应的是**脚本B：全网数据计算**（`scripts/scrapers/calculate-global-stats.ts`）

### 核心职责

**只负责计算宏观统计数据，不修改具体市场状态**

### 功能

1. **从Polymarket API获取全量活跃市场数据**
   - 最多获取1000条活跃市场
   - 按交易量降序排序

2. **计算全网统计数据**：
   - **进行中事件**：统计活跃事件总数（去重后）
   - **24H 交易量**：计算所有市场的总交易量
   - **总锁仓量 (TVL)**：计算所有市场的总流动性
   - **24H 活跃交易者**：基于交易量估算（每 $10,000 交易量 = 1 个活跃用户）

3. **更新GlobalStat表**：
   - 直接写入中文标签对应的指标值
   - 只更新已存在且启用的指标

4. **防破坏逻辑**：
   - 如果指标不存在或被禁用，脚本**禁止创建或更新**
   - 必须先通过后台管理界面创建指标

5. **更新监控状态**：
   - 更新 `scraper_tasks` 表中 `name === 'GlobalStats_Calc'` 的记录

### 数据流程

```
Polymarket Gamma API
    ↓ (获取1000条活跃市场)
脚本B (calculate-global-stats.ts)
    ↓ (计算统计数据)
global_stats 表
    ↓ (更新指标值)
/api/stats API
    ↓ (前端每60秒请求)
前端 MarketOverview 组件
    ↓ (显示实时数据)
用户看到的数据面板
```

### 运行方式

**手动运行**：
```bash
npx tsx scripts/scrapers/calculate-global-stats.ts
```

**定时任务**（建议）：
- 每10分钟运行一次
- 可通过cron或后台管理界面设置

### 与"Polymarket"采集源的区别

| 采集源 | 作用 | 数据量 | 更新内容 |
|--------|------|--------|----------|
| **Polymarket** | 同步外部市场数据 | 500条 | 更新具体市场的赔率、交易量等 |
| **全网数据** | 计算宏观统计 | 1000条 | 只更新全局指标（进行中事件、24H交易量等） |

**关键区别**：
- **Polymarket采集源**：更新**具体市场**的数据（如BTC 15min市场的赔率）
- **全网数据采集源**：计算**宏观统计**（如全网总交易量、总事件数）

### 注意事项

1. **指标必须先创建**：脚本不会自动创建指标，必须先通过后台管理界面创建
2. **指标名称必须精确匹配**：包括空格和大小写
3. **只更新数值**：脚本只更新 `value` 字段，不修改其他字段
4. **防破坏逻辑**：如果指标被禁用，脚本不会更新它

### 相关文件

- **计算脚本**: `scripts/scrapers/calculate-global-stats.ts`
- **API接口**: `app/api/stats/route.ts`
- **前端组件**: `components/MarketOverview.tsx`
- **后台管理API**: `app/api/admin/stats/route.ts`
- **采集源配置**: `app/api/admin/scrapers/route.ts`

