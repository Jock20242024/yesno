# 上线前检查清单

## 📋 总体评估

根据代码库检查，**建议进行部分清理和检查**，但不建议进行大规模的"数据大清洗"。

---

## ✅ 必须执行的检查项目

### 1. **代码清理（高优先级）**

#### 1.1 移除/清理调试日志
- **问题**：代码中有 **815+ 个 `console.log/warn/error`**
- **影响**：可能暴露敏感信息，影响性能
- **建议**：
  ```bash
  # 查找所有 console.log
  grep -r "console\.log" app/ components/ lib/ --include="*.ts" --include="*.tsx" | wc -l
  
  # 建议保留：
  # - 错误日志 (console.error)
  # - 重要警告 (console.warn)
  # - 关键 API 调用的日志（生产环境可配置）
  
  # 建议移除：
  # - 调试日志 (console.log)
  # - 临时调试代码
  ```

#### 1.2 处理 TODO/FIXME 注释
- **问题**：代码中有 **114+ 个 TODO/FIXME** 标记
- **建议**：
  - 审查每个 TODO/FIXME，确定是否需要在发布前处理
  - 对于必须修复的，标记为 P0/P1
  - 对于可以延后的，创建 GitHub Issues

### 2. **安全审计（高优先级）**

#### 2.1 API 安全
- ✅ **数据隔离**：已修复（根据 `DATA-ISOLATION-AUDIT-REPORT.md`）
- ✅ **用户认证**：使用 NextAuth，已实施
- ⚠️ **API Key 安全**：检查 API Key 的使用和存储
- ⚠️ **环境变量**：确保所有敏感信息都在 `.env` 中，不在代码中硬编码

#### 2.2 数据验证
- ✅ **输入验证**：检查所有 API 端点是否有适当的输入验证
- ✅ **SQL 注入防护**：使用 Prisma（已防护）
- ⚠️ **XSS 防护**：确保所有用户输入都经过清理

### 3. **数据库检查（中优先级）**

#### 3.1 测试数据清理
- ⚠️ **检查测试用户**：
  ```sql
  -- 检查是否有测试用户
  SELECT * FROM User WHERE email LIKE '%test%' OR email LIKE '%example%';
  
  -- 检查是否有测试市场
  SELECT * FROM Market WHERE title LIKE '%test%' OR title LIKE '%Test%';
  ```

#### 3.2 数据一致性
- ✅ **外键约束**：确保数据库外键正确设置
- ⚠️ **孤立数据**：检查是否有孤立的市场、订单等
- ⚠️ **系统账户**：确认系统账户（如 `system.fee@yesno.com`）已正确创建

### 4. **性能优化（中优先级）**

#### 4.1 前端性能
- ⚠️ **图片优化**：确保所有图片都经过优化
- ⚠️ **代码分割**：检查 Next.js 的代码分割是否合理
- ⚠️ **缓存策略**：检查 API 缓存策略是否合理

#### 4.2 数据库性能
- ⚠️ **索引检查**：确保常用查询字段都有索引
- ⚠️ **N+1 查询**：检查是否有 N+1 查询问题

### 5. **功能完整性检查（高优先级）**

#### 5.1 核心功能
- ✅ **用户注册/登录**：已验证
- ✅ **市场创建/显示**：已验证
- ✅ **订单处理**：已验证
- ⚠️ **支付流程**：全面测试充值和提现流程
- ⚠️ **结算流程**：测试市场结算功能

#### 5.2 边界情况
- ⚠️ **空数据处理**：测试空市场列表、空订单列表等
- ⚠️ **错误处理**：测试各种错误情况的处理
- ⚠️ **并发测试**：测试多用户同时操作的场景

---

## ⚠️ 不建议大规模执行的项目

### 1. **数据库"大清洗"**
- **原因**：根据代码检查，数据隔离问题已修复，不需要大规模数据清理
- **建议**：只清理明显的测试数据即可

### 2. **全面重构**
- **原因**：代码结构已相对稳定，大规模重构风险高
- **建议**：只修复明确的 bug，避免在发布前大幅改动

---

## 📝 推荐执行顺序

### 第一阶段（1-2天）：关键清理
1. ✅ 移除所有 `console.log` 调试日志
2. ✅ 审查并处理关键的 TODO/FIXME
3. ✅ 安全审计（API 安全、环境变量）
4. ✅ 清理明显的测试数据

### 第二阶段（1-2天）：功能验证
1. ✅ 完整功能测试（核心流程）
2. ✅ 边界情况测试
3. ✅ 性能测试（关键页面）
4. ✅ 数据库索引检查

### 第三阶段（1天）：最终检查
1. ✅ 代码审查（关键文件）
2. ✅ 文档更新
3. ✅ 部署准备（环境变量、配置文件）

---

## 🔍 自动检查脚本建议

创建以下检查脚本：

```bash
# 1. 检查硬编码的敏感信息
grep -r "password\|secret\|key\|token" app/ lib/ --include="*.ts" --include="*.tsx" | grep -v ".env"

# 2. 检查 TODO/FIXME
grep -r "TODO\|FIXME\|XXX\|HACK" app/ components/ lib/ --include="*.ts" --include="*.tsx"

# 3. 检查 console.log
grep -r "console\.log" app/ components/ lib/ --include="*.ts" --include="*.tsx"

# 4. 检查未使用的导入
# 可以使用 ESLint 的 unused-imports 规则
```

---

## ✅ 检查清单总结

### 必须执行（P0）
- [ ] 移除 `console.log` 调试日志
- [ ] 安全审计（API、环境变量）
- [ ] 清理测试数据
- [ ] 核心功能完整测试

### 建议执行（P1）
- [ ] 处理关键的 TODO/FIXME
- [ ] 数据库索引优化
- [ ] 性能测试
- [ ] 边界情况测试

### 可选执行（P2）
- [ ] 代码重构（小范围）
- [ ] 文档完善
- [ ] 监控和日志系统配置

---

## 🎯 最终建议

**不建议进行大规模"数据大清洗"**，原因：
1. 数据隔离问题已修复
2. 大规模数据操作风险高
3. 可能影响现有功能

**建议执行的重点**：
1. ✅ **代码清理**（移除调试日志）- 必须
2. ✅ **安全审计** - 必须
3. ✅ **功能测试** - 必须
4. ✅ **测试数据清理** - 建议

**预计时间**：3-5 个工作日

