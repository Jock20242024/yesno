# ✅ 最终解决方案（简化版）

## 资金账目（修正）

**用户投入**：$200（两次订单，每次$100）

**资金分解**：
1. **手续费**：$10（两次订单，每次$5）→ 归平台
2. **点差收益**：$22.08 → 归AMM账户  
3. **持仓份额价值**：$39.19（shares * avgPrice）→ 已转换为持仓
4. **滑点损失**：$118.73 → 虚拟损失（已体现在avgPrice中）

**总计验证**：
- 扣除手续费后净投入：$200 - $10 = $190 ✅
- 资金去向：$10 + $22.08 + $39.19 + $118.73 = $190 ✅
- **账目正确**

---

## 核心问题

**用户困惑**：为什么投入$200，但持仓份额价值只有$39.19？钱去哪了？

**答案**：
- $10 手续费（归平台）
- $22.08 点差收益（归AMM）
- $39.19 已转换为持仓份额
- $118.73 滑点损失（CPMM公式导致，已体现在avgPrice中）

---

## 最佳解决方案（3步）

### 步骤1：修复前端显示 ✅

**显示逻辑**：
```
总投入：        $200.00  （用户实际投入）
├─ 手续费：      $10.00  （已扣除）
└─ 净投入：      $190.00  （实际参与交易）

持仓详情：
├─ 持仓份额：    39.583 Yes
├─ 持仓份额价值： $39.19  （shares * avgPrice）
├─ 持仓成本：     $190.00 （净投入金额）
└─ 当前价值：     $1.58

资金去向明细：
├─ 手续费：      $10.00   (5.0%)  → 平台费用
├─ 点差费用：    $22.08   (11.1%) → AMM做市利润
├─ 持仓份额价值： $39.19   (19.7%) → 已转换为持仓
└─ 滑点损失：    $118.73  (59.7%) → CPMM公式导致（已体现在avgPrice中）
```

**修改文件**：`components/wallet/PositionsTable.tsx`

---

### 步骤2：确保持仓成本使用实际投入金额 ✅

**已修复**：`app/api/positions/route.ts` 第216行
```typescript
const costBasis = actualInvestedAmount > 0 ? actualInvestedAmount : valuation.costBasis;
```

**验证**：访问 `/api/positions?type=active`，确认 `costBasis = $190`

---

### 步骤3：修复SQL查询 ✅

**已修复**：`CORRECT-SQL-QUERIES.sql`，使用子查询代替CTE

---

## 立即执行

1. **修复SQL查询**：已修复，重新执行即可
2. **修改前端显示**：在持仓详情中添加资金流向明细
3. **验证修复**：查看持仓详情，确认显示正确

**不要改的**：
- ❌ 不要修改CPMM公式
- ❌ 不要修改avgPrice计算逻辑（除非确认是错的）
- ❌ 不要隐藏滑点损失

