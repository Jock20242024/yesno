# ğŸ—ï¸ å¸‚åœºæ¶æ„å½»åº•é‡æ„ - å·¥å‚å¸‚åœºä¸ç‹¬ç«‹å¸‚åœºå®Œå…¨åˆ†ç¦»

## é‡æ„ç›®æ ‡

å½»åº•åˆ†ç¦»å·¥å‚å¸‚åœºå’Œç‹¬ç«‹å¸‚åœºçš„å¤„ç†é€»è¾‘ï¼Œé¿å…æœªæ¥çš„åå¤ä¿®å¤ã€‚

## æ¶æ„è®¾è®¡

### 1. å¸‚åœºç±»å‹å®šä¹‰ (`lib/marketTypeDetection.ts`)

**æ ¸å¿ƒåŸåˆ™**ï¼š
- **å·¥å‚å¸‚åœº**ï¼šç”±è‡ªåŠ¨åŒ–å·¥å‚ç”Ÿæˆçš„æ—¶é—´åºåˆ—å¸‚åœºï¼ˆ15åˆ†é’Ÿã€1å°æ—¶ç­‰å‘¨æœŸï¼‰
  - ç‰¹å¾ï¼šæœ‰ templateIdï¼ˆä¸æ˜¯ manual-/poly- å¼€å¤´ï¼‰ä¸”æœ‰ period
  - è¡Œä¸ºï¼šéœ€è¦èšåˆå’Œæ—¶é—´è¿‡æ»¤
  
- **ç‹¬ç«‹å¸‚åœº**ï¼šæ‰‹åŠ¨åˆ›å»ºæˆ– Polymarket å®¡æ ¸é€šè¿‡çš„å¸‚åœº
  - ç‰¹å¾ï¼šæ²¡æœ‰ templateIdï¼Œæˆ– templateId ä»¥ manual-/poly- å¼€å¤´
  - è¡Œä¸ºï¼šæ¯ä¸ªéƒ½æ˜¯ç‹¬ç«‹å±•ç¤ºé¡¹ï¼Œä¸å‚ä¸èšåˆå’Œæ—¶é—´è¿‡æ»¤

**å‡½æ•°**ï¼š
- `isFactoryMarket(market)` - åˆ¤æ–­æ˜¯å¦ä¸ºå·¥å‚å¸‚åœº
- `isIndependentMarket(market)` - åˆ¤æ–­æ˜¯å¦ä¸ºç‹¬ç«‹å¸‚åœº
- `getMarketAggregationKey(market)` - è·å–èšåˆé”®

### 2. èšåˆé€»è¾‘é‡æ„ (`lib/marketAggregation.ts`)

**åˆ†ç¦»å¤„ç†**ï¼š
- `aggregateFactoryMarkets()` - åªå¤„ç†å·¥å‚å¸‚åœºï¼Œè¿›è¡Œèšåˆå’Œæ—¶é—´è¿‡æ»¤
- `aggregateMarketsByTemplate()` - ä¸»å‡½æ•°ï¼Œåˆ†ç¦»å·¥å‚å¸‚åœºå’Œç‹¬ç«‹å¸‚åœºï¼Œåˆ†åˆ«å¤„ç†

**å…³é”®æ”¹è¿›**ï¼š
- å·¥å‚å¸‚åœºï¼šä½¿ç”¨ `templateId + period` ä½œä¸ºèšåˆé”®ï¼Œè¿›è¡Œæ—¶é—´è¿‡æ»¤
- ç‹¬ç«‹å¸‚åœºï¼šç›´æ¥è¿”å›ï¼Œä¸è¿›è¡Œä»»ä½•è¿‡æ»¤

### 3. API æŸ¥è¯¢ç»Ÿä¸€ (`app/api/markets/route.ts`)

**ä¸‰å±‚é˜²å¾¡**ï¼š
1. æ•°æ®åº“æŸ¥è¯¢å±‚ï¼š`BASE_MARKET_FILTER` åŒ…å« `isActive: true`
2. æ•°æ®è½¬æ¢å±‚ï¼šåœ¨åºåˆ—åŒ–æ—¶å†æ¬¡æ£€æŸ¥ `isActive`
3. å‰ç«¯é˜²å¾¡å±‚ï¼šåœ¨æ¸²æŸ“å‰å†æ¬¡æ£€æŸ¥ `isActive`

**åˆ†ç¦»é€»è¾‘**ï¼š
- ä½¿ç”¨ `isIndependentMarket()` ç»Ÿä¸€åˆ¤æ–­
- å·¥å‚å¸‚åœºå’Œç‹¬ç«‹å¸‚åœºåˆ†å¼€å¤„ç†åå†åˆå¹¶

## ä¿®å¤çš„é—®é¢˜

### 1. å·²åˆ é™¤çš„å¸‚åœºä»æ˜¾ç¤º
**åŸå› **ï¼šç¼“å­˜æˆ–æ•°æ®è½¬æ¢æ—¶æœªæ£€æŸ¥ `isActive`

**ä¿®å¤**ï¼š
- âœ… æ•°æ®åº“æŸ¥è¯¢å±‚ï¼šå¼ºåˆ¶ `isActive: true`
- âœ… API åºåˆ—åŒ–å±‚ï¼šè¿‡æ»¤æ‰ `isActive: false`
- âœ… å‰ç«¯æ¸²æŸ“å±‚ï¼šå†æ¬¡æ£€æŸ¥ `isActive`
- âœ… å“åº”å¤´ï¼šç¦æ­¢ç¼“å­˜

### 2. ç‹¬ç«‹å¸‚åœºè¢«è¯¯è¿‡æ»¤
**åŸå› **ï¼šæ‰‹åŠ¨åˆ›å»ºçš„å¸‚åœºï¼ˆmanual- å¼€å¤´ï¼‰è¢«å½“ä½œå·¥å‚å¸‚åœºå¤„ç†

**ä¿®å¤**ï¼š
- âœ… åˆ›å»º `marketTypeDetection.ts` ç»Ÿä¸€åˆ¤æ–­é€»è¾‘
- âœ… é‡æ„èšåˆå‡½æ•°ï¼Œå½»åº•åˆ†ç¦»å·¥å‚å’Œç‹¬ç«‹å¸‚åœº
- âœ… ç‹¬ç«‹å¸‚åœºä¸å‚ä¸æ—¶é—´è¿‡æ»¤

## ä½¿ç”¨æ–¹å¼

### åˆ¤æ–­å¸‚åœºç±»å‹
```typescript
import { isFactoryMarket, isIndependentMarket } from '@/lib/marketTypeDetection';

if (isFactoryMarket(market)) {
  // å·¥å‚å¸‚åœºé€»è¾‘
}

if (isIndependentMarket(market)) {
  // ç‹¬ç«‹å¸‚åœºé€»è¾‘
}
```

### èšåˆå¸‚åœº
```typescript
import { aggregateMarketsByTemplate } from '@/lib/marketAggregation';

const aggregated = aggregateMarketsByTemplate(markets);
```

## éªŒè¯æ¸…å•

- [ ] å·²åˆ é™¤çš„å¸‚åœºï¼ˆisActive=falseï¼‰ä¸ä¼šå‡ºç°åœ¨å‰ç«¯
- [ ] æ‰‹åŠ¨åˆ›å»ºçš„å¸‚åœºï¼ˆmanual- å¼€å¤´ï¼‰æ­£å¸¸æ˜¾ç¤º
- [ ] Polymarket å®¡æ ¸é€šè¿‡çš„å¸‚åœºï¼ˆpoly- å¼€å¤´ï¼‰æ­£å¸¸æ˜¾ç¤º
- [ ] å·¥å‚å¸‚åœºæ­£ç¡®èšåˆï¼Œåªæ˜¾ç¤ºå½“å‰æ´»è·ƒåœºæ¬¡
- [ ] ç‹¬ç«‹å¸‚åœºæ¯ä¸ªéƒ½æ˜¯ç‹¬ç«‹å±•ç¤ºé¡¹
