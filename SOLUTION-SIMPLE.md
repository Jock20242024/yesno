# ✅ 最终解决方案（简洁版）

## 资金账目（正确版）

**用户投入**：$200（两次订单，每次$100）

**资金分解**：
```
用户投入：        $200.00
├─ 手续费：        $10.00  (5%)   → 归平台
├─ 点差收益：      $22.08  (11%)  → 归AMM账户  
├─ 持仓份额价值：  $39.19  (20%)  → 已转换为持仓（shares * avgPrice）
└─ 滑点损失：      $118.73 (59%)  → 虚拟损失（已体现在avgPrice中）

净投入：          $190.00  ✅ ($200 - $10手续费)
验证：            $10 + $22.08 + $39.19 + $118.73 = $190 ✅
```

---

## 最佳解决方案（3步）

### 步骤1：前端显示完整资金流向 ✅

**修改文件**：`components/wallet/PositionsTable.tsx` 或持仓详情组件

**显示内容**：
```
总投入：        $200.00
手续费：        $10.00
净投入：        $190.00

持仓详情：
├─ 持仓份额：    39.583 Yes
├─ 持仓份额价值： $39.19  （shares * avgPrice）
├─ 持仓成本：     $190.00 （净投入金额）
└─ 当前价值：     $1.58

资金去向：
├─ 手续费：      $10.00   (5.0%)   → 平台费用
├─ 点差费用：    $22.08   (11.1%)  → AMM做市利润
├─ 持仓份额价值： $39.19   (19.7%)  → 已转换为持仓
└─ 滑点损失：    $118.73  (59.7%)  → CPMM公式导致（已体现在avgPrice中）

盈亏计算：
盈亏 = 当前价值 - 持仓成本 = $1.58 - $190.00 = -$188.42
```

**优点**：用户一目了然知道钱去哪了

---

### 步骤2：确认后端已修复 ✅

**已修复**：`app/api/positions/route.ts` 第216行
```typescript
const costBasis = actualInvestedAmount > 0 ? actualInvestedAmount : valuation.costBasis;
```

**验证**：访问 `/api/positions?type=active`，确认 `costBasis = $190`

---

### 步骤3：SQL查询已修复 ✅

**已修复**：使用子查询代替CTE，避免PostgreSQL语法错误

**重新执行**：`CORRECT-SQL-QUERIES.sql` 步骤3

---

## 核心要点

1. **账目正确**：$200投入，$10手续费，$190净投入，资金去向清楚
2. **持仓成本**：使用实际投入金额（$190），不是shares * avgPrice（$39.19）
3. **资金流向**：前端明确显示所有资金去向，避免用户困惑

**不要改的**：
- ❌ 不要修改CPMM公式
- ❌ 不要修改avgPrice计算（除非确认是错的）

