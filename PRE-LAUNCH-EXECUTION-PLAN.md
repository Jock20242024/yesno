# 上线前执行计划（专业建议）

## 🎯 执行顺序（按优先级）

### **阶段 0：全盘扫描代码检查（1-2天）** ⭐ 第一步

**为什么先做这个？**
- 了解整体代码健康状况
- 发现潜在的安全隐患和 bug
- 为后续清理工作提供依据
- 避免在清理过程中引入新问题

**执行内容：**
1. 静态代码分析
   - TypeScript 类型检查
   - ESLint 检查
   - 代码复杂度分析
2. 安全检查
   - 敏感信息泄漏检查（API keys, passwords）
   - SQL 注入风险检查
   - XSS 风险检查
   - 认证/授权漏洞检查
3. 架构检查
   - 依赖关系分析
   - 死代码检测
   - 重复代码检测
4. 问题分类
   - P0（阻塞上线）
   - P1（建议修复）
   - P2（可选优化）

**产出：**
- 问题清单和优先级
- 修复建议

---

### **阶段 1：修复 P0 问题（1-2天）** ⭐ 第二步

**为什么在做清理前先修复？**
- 确保系统基本可用
- 避免清理过程中引入新的 bug
- 清理工作基于稳定的代码基础

**执行内容：**
- 修复所有 P0 级别的 bug 和安全问题
- 确保核心功能正常

---

### **阶段 2：清洗脏数据（0.5-1天）** ⭐ 第三步

**为什么在代码清理前做？**
- 数据清理可能影响功能测试
- 清理后的数据状态更接近生产环境
- 可以在干净的数据库上测试代码清理后的效果

**执行内容：**
1. 识别测试数据
   ```sql
   -- 测试用户
   SELECT * FROM User WHERE email LIKE '%test%' OR email LIKE '%example%';
   
   -- 测试市场
   SELECT * FROM Market WHERE title LIKE '%test%' OR title LIKE '%Test%';
   
   -- 孤立数据
   -- 检查订单没有关联的市场
   SELECT o.* FROM Order o 
   LEFT JOIN Market m ON o.marketId = m.id 
   WHERE m.id IS NULL;
   ```

2. 备份数据（必须！）
   ```bash
   # 数据库备份
   pg_dump -h localhost -U postgres yesno_db > backup_$(date +%Y%m%d).sql
   ```

3. 执行清理
   - 删除测试用户（保留系统账户）
   - 删除测试市场
   - 清理孤立数据
   - 验证系统账户完整性

**注意事项：**
- ⚠️ 必须先在测试环境执行
- ⚠️ 必须有数据备份
- ⚠️ 记录所有删除操作

---

### **阶段 3：代码清理（1-2天）** ⭐ 第四步

**为什么在数据清理后做？**
- 基于干净的数据测试清理后的代码
- 避免清理过程中数据问题干扰

**执行内容：**

1. 移除调试日志（console.log）
   - 保留 console.error（错误日志）
   - 保留 console.warn（重要警告）
   - 移除所有 console.log
   - 可以使用环境变量控制日志级别

2. 审查 TODO/FIXME
   - 分类处理：
     - **必须修复**：立即修复
     - **可以延后**：创建 GitHub Issues
     - **已过时**：删除注释

3. 代码格式化和优化
   - 统一代码风格
   - 移除未使用的导入
   - 优化导入顺序

---

### **阶段 4：配置生产环境（1天）** ⭐ 最后一步

**为什么最后做？**
- 基于清理后的代码配置
- 确保所有代码问题都已解决
- 避免配置后还需要修改代码

**执行内容：**
1. 环境变量配置
   - 数据库连接字符串
   - API keys
   - 第三方服务配置
   - 日志级别设置

2. 生产环境配置
   - Next.js 构建优化
   - 缓存策略配置
   - CDN 配置（如需要）
   - 监控和日志系统

3. 安全检查
   - 确保所有敏感信息都在环境变量中
   - 确保没有硬编码的配置
   - 检查 CORS 设置
   - 检查 HTTPS 配置

---

## 📊 执行时间表

```
Day 1-2:  阶段 0 - 全盘扫描代码检查
Day 3-4:  阶段 1 - 修复 P0 问题
Day 5:    阶段 2 - 清洗脏数据
Day 6-7:  阶段 3 - 代码清理
Day 8:    阶段 4 - 配置生产环境
Day 9:    最终测试和验证
Day 10:   上线准备和文档
```

**总计：约 10 个工作日（2 周）**

---

## 🔄 推荐的迭代方式

### 方式 1：快速上线（5-7 天）
如果时间紧迫，可以并行执行：

```
Day 1:  阶段 0（部分）+ 阶段 2（数据清理）
Day 2:  阶段 0（完成）+ 阶段 3（部分）
Day 3:  阶段 1（P0 修复）
Day 4:  阶段 3（完成）
Day 5:  阶段 4（配置）
Day 6:  最终测试
```

### 方式 2：稳妥上线（10-14 天）⭐ 推荐
按顺序执行，确保质量：

```
严格按照上述时间表执行
每个阶段完成后进行验证
发现新问题及时调整
```

---

## ⚠️ 关键注意事项

### 1. 数据备份
- **每次数据操作前必须备份**
- 备份应该包括：
  - 完整数据库备份
  - 关键配置文件备份
  - 环境变量备份

### 2. 测试环境验证
- **所有操作先在测试环境执行**
- 验证无误后再在生产环境执行

### 3. 版本控制
- **每个阶段完成后提交代码**
- 使用清晰的 commit message
- 保留回滚能力

### 4. 文档记录
- 记录所有修改
- 记录清理的数据
- 记录配置变更

---

## 🎯 我的专业建议

### **最佳执行顺序：**

1. **阶段 0：全盘扫描** ⭐⭐⭐
   - **最先执行**
   - 了解整体状况
   - 避免盲目操作

2. **阶段 1：修复 P0 问题** ⭐⭐⭐
   - **第二执行**
   - 确保系统稳定
   - 为后续工作打基础

3. **阶段 2：清洗脏数据** ⭐⭐
   - **第三执行**
   - 在稳定代码基础上清理数据
   - 避免数据问题干扰测试

4. **阶段 3：代码清理** ⭐⭐
   - **第四执行**
   - 在干净数据上测试清理后的代码
   - 更容易发现问题

5. **阶段 4：配置生产环境** ⭐⭐⭐
   - **最后执行**
   - 基于最终代码配置
   - 避免重复配置

### **为什么不建议先清洗数据？**

1. 不知道哪些数据是"脏"的
   - 需要先扫描代码，了解测试数据的使用情况
2. 可能误删重要数据
   - 代码检查可能发现某些"测试"数据实际在使用
3. 缺乏清理依据
   - 不知道清理的标准是什么

### **为什么不建议先清理代码？**

1. 可能隐藏问题
   - console.log 可能有助于发现 bug
2. 修复问题时可能需要调试日志
   - 先修复 bug，再移除日志更安全

---

## 📋 快速检查清单

### 阶段 0：全盘扫描
- [ ] 运行 TypeScript 类型检查
- [ ] 运行 ESLint
- [ ] 检查敏感信息泄漏
- [ ] 检查安全漏洞
- [ ] 生成问题清单

### 阶段 1：修复 P0
- [ ] 修复阻塞性 bug
- [ ] 修复安全问题
- [ ] 验证核心功能

### 阶段 2：清洗数据
- [ ] 备份数据库
- [ ] 识别测试数据
- [ ] 执行清理
- [ ] 验证数据完整性

### 阶段 3：代码清理
- [ ] 移除 console.log
- [ ] 处理 TODO/FIXME
- [ ] 代码格式化
- [ ] 验证功能正常

### 阶段 4：生产配置
- [ ] 配置环境变量
- [ ] 优化构建配置
- [ ] 配置监控
- [ ] 最终安全检查

---

## 💡 总结

**我的专业建议是：**

1. ✅ **先进行全盘扫描代码检查**（阶段 0）
2. ✅ **修复发现的 P0 问题**（阶段 1）
3. ✅ **然后清洗脏数据**（阶段 2）
4. ✅ **接着进行代码清理**（阶段 3）
5. ✅ **最后配置生产环境**（阶段 4）

**理由：**
- 先了解整体状况，避免盲目操作
- 先修复关键问题，确保系统稳定
- 再清理数据和代码，降低风险
- 最后配置生产环境，避免重复工作

**预计时间：10 个工作日（2 周）**

